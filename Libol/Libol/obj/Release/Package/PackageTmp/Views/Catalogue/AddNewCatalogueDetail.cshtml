@using System.Linq;
@using Libol.Models;
@using Libol.EntityResult;
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    #textColorInput {
        color: red;
    }

    label {
        text-align: right;
    }
</style>
<h4 style="margin:1rem">Biên Mục Chi Tiết</h4>
<form action="~/Catalogue/AddNewCatalogue" method="post">
    @{
        SP_CATA_GET_CONTENTS_OF_ITEMS_Result Leader = ViewData["Leader"] as SP_CATA_GET_CONTENTS_OF_ITEMS_Result;
        List<SP_CATA_GET_CONTENTS_OF_ITEMS_Result> Contents = ViewData["ListContent"] as List<SP_CATA_GET_CONTENTS_OF_ITEMS_Result>;
        List<SP_CATA_GET_MODIFIED_FIELDS_Result> Fields = ViewData["listField"] as List<SP_CATA_GET_MODIFIED_FIELDS_Result>;
        var res = Contents.Zip(Fields, (c, f) => new { Content = c, Field = f });
    }


    <div id="formCreated">
        @{
        <label class='control-label align-self-center font-weight-bold'>Leader </label> <br>
            <div class="form-group row col-12">
                <label class='control-label col-md-2 align-self-center font-weight-bold'></label>
                @Html.TextBox(Leader.Content, Leader.Content, new { @class = "form-control col-md-9", @id = Leader.IDSort })
            </div>
            foreach (var item in res)
            {
                if (item.Content.Ind != "")
                {
                    <label class='control-label align-self-center font-weight-bold'>@item.Content.IDSort : @item.Field.VietFieldName</label> <br>
                    <div class="form-group row col-12">

                        <label class='control-label col-md-2 align-self-center font-weight-bold'>@item.Content.IDSort </label>
                        @Html.TextBox(item.Content.FieldCode, item.Content.Content, new { @class = "form-control col-md-9", @id = item.Content.IDSort })
                        @Html.TextBox(item.Content.Ind, item.Content.Ind, new { @class = "form-control col-md-1", @id = item.Content.IDSort, @maxlength = 2 })

                    </div>
                }
                else
                {
                    <label class='control-label align-self-center font-weight-bold'>@item.Content.IDSort : @item.Field.VietFieldName</label> <br>
                    <div class="form-group row col-12">
                        <label class='control-label col-md-2 align-self-center font-weight-bold'>@item.Content.IDSort </label>
                        @Html.TextBox(item.Content.FieldCode, item.Content.Content, new { @class = "form-control col-md-9", @id = item.Content.IDSort })
                    </div>
                }

            }

        }
        col-md-3

    </div>

    <div class="form-group col-md-12 form-inline">
        <div class="form-row col-md-12 text-center">
            <div style="margin : auto">
                <input type="button" id="btnCreate" class="btn btn-primary form-control" value="Cập Nhập" onclick="doWork();" />
                @*<button disabled type="button" id="btnReset" class="btn btn-primary form-control">Đặt Lại</button>*@
                <button disabled type="button" id="btnAddField" class="btn btn-primary form-control" data-toggle="modal" data-target="#myModal">Thêm Trường</button>
            </div>
        </div>
    </div>
</form>





<!--The Modal -->
<div class="modal fade" id="centralModalSm" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Tạo Mới Thành Công</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Mã Tài Liệu : <label class='col-md-2 align-self-center font-weight-bold' id="codeId"></label>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-info" onclick="location.href='/Catalogue/AddCatalogueDetail';">Thêm Trường</button>
                <button type="button" class="btn btn-success" onclick="location.href='/Catalogue/AddNewCatalogue';">Biên Mục Mới</button>
                <button type="button" class="btn btn-secondary" id="btnShelf">Xếp Giá</button>
            </div>
        </div>
    </div>
</div>


<script>
    var Data = [];
    function SelectedForm() {
        Data = ["001"];
        var empObj = {
            intIsAuthority: 0,
            intFormID: $("#listMarcFormID :selected").val()
        };
        var html = "";
        $.ajax({
            url: "/Catalogue/LoadFormComplated",
            type: "POST",
            data: JSON.stringify(empObj),
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (result) {
                $.each(result, function (i, item) {
                    Data.push(item.FieldCode);
                    var field = item.FieldCode;

                    field = field.replace('$', '');
                    if (item.FieldCode == '245$b') {
                        html += "<div class='form-group row col-12' id ='dv" + field + "'><label class='control-label col-md-5 align-self-center font-weight-bold'  id ='lb" + field + "' > Nhan Đề Song Song [" + item.FieldCode + "]" + "</label><input type='text' class='form-control col-md-2' id=" + field + "1></input>     </div> " +
                            "<div class='form-group row col-12' id ='dv" + field + "'><label class='control-label col-md-5 align-self-center font-weight-bold'  id ='lb" + field + "' > Phụ Đề [" + item.FieldCode + "]" + "</label><input type='text' class='form-control col-md-2' id=" + field + "2></input>     </div>";
                    }
                    else if (!(item.FieldCode == '900' || item.FieldCode == '911' || item.FieldCode == '925' || item.FieldCode == '926' || item.FieldCode == '927')) {
                        html += "<div class='form-group row col-12' id ='dv" + field + "'><label class='control-label col-md-5 align-self-center font-weight-bold'  id ='lb" + field + "' > " + item.VietFieldName + " [" + item.FieldCode + "]" + "</label><input type='text' class='form-control col-md-2' id=" + field + "></input> </div>";
                    }
                });
                $("#formCreated").html(html);
                //$('#dv245a').append("<button type='button' id='btn' class='btn btn-info' onclick='clicked(dv245a);'>Info</button>");
                document.getElementById("lb245a").style.color = "red";
                document.getElementById("btnCreate").disabled = false;
                document.getElementById("btnReset").disabled = false;
                document.getElementById("btnAddField").disabled = false;
                $(document).ready(function () {
                    //check tittle
                    $("#245a").focusout(function () {
                        checkTitle($('#245a').val(), '');

                    });

                    //Check ISBN  \\ Chưa check cho trường hợp lặp
                    $("#020a").focusout(function () {
                        checkItemNumber($('#020a').val(), '020$a');
                    });

                });
            },
            error: function (errorThrown) {
                alert(errorThrown);
            }

        });

    }
    function checkTitle(tit, type) {
        $.ajax({
            url: "/Catalogue/CheckTitle",
            type: "POST",
            data: JSON.stringify({ strTitle: tit, strItemType: type }),
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (listTitle) {
                if (listTitle.length > 0) {
                    $('#245a').focus();
                    //alert
                }
            },
            error: function (errorThrown) {
                alert(errorThrown);
            }

        });
    }
    function checkItemNumber(value, code) {
        debugger;
        $.ajax({
            url: "/Catalogue/CheckItemNumber",
            type: "POST",
            data: JSON.stringify({ strFieldValue: value, strFieldCode: code }),
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (Value) {
                if (Value > 0) {
                    alert('Mã ISBN : ' + value + '  đã được sử dụng');
                }

            },
            error: function (errorThrown) {
                alert(errorThrown);
            }

        });
    }

</script>


<script>


    function doWork() {
        var arrFieldName = [];
        var arrFieldValue = [];
        arrFieldName.push('FormId');
        arrFieldValue.push($("#listMarcFormID :selected").val());
        arrFieldName.push('DirLevel');
        arrFieldValue.push($("#levelDir :selected").val());
        arrFieldName.push('RecordType');
        arrFieldValue.push($("#recordTypeCode :selected").val());
        $.each(Data, function (i, item) {
            inputId = item.replace('$', '');
            //get Value of inputTag base FieldCode
            var strValue = $("#" + inputId).val();
            switch (item) {
                case '926':
                    arrFieldName.push(item);
                    arrFieldValue.push($("#accessLevel :selected").val());
                    break;
                case '925':
                    arrFieldName.push(item);
                    arrFieldValue.push($("#mediumId :selected").val());
                    break;
                case '927':
                    arrFieldName.push(item);
                    arrFieldValue.push($("#itemTypeId :selected").val());
                    break;
                case '020$a':
                    getRepeatValue(item, strValue);
                    break;
                case '022$a':
                    getRepeatValue(item, strValue);
                    break;
                case '245$b':
                    //Nhan Đề song song
                    var strValue1 = $("#" + inputId + "1").val();
                    arrFieldName.push(item + "1");
                    arrFieldValue.push(strValue1);
                    //phụ đề
                    var strValue2 = $("#" + inputId + "2").val();
                    arrFieldName.push(item + "2");
                    arrFieldValue.push(strValue2);
                    break;
                case '650$a':
                    getRepeatValue(item, strValue);
                    break;
                case '653$a':
                    getRepeatValue(item, strValue);
                    break;
                case '700$a':
                    getRepeatValue(item, strValue);
                    break;
                default:
                    arrFieldName.push(item);
                    arrFieldValue.push(strValue);
            }
        });

        //Insert Item

        $.ajax({
            url: "/Catalogue/InsertOrUpdateCatalogue",
            type: "POST",
            data: JSON.stringify({ listFieldsName: arrFieldName, listFieldsValue: arrFieldValue }),
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (code) {
                //pop up Modal
                $('#codeId').text(code);
                $('#centralModalSm').modal({ backdrop: 'static', keyboard: false })
                $('#centralModalSm').modal('toggle');
                $('#btnShelf').click(function () {
                    window.location.href = '/Shelf/Index?Code=' + code;
                });

            },
            error: function (errorThrown) {
                alert(errorThrown);
            }

        });

        function getRepeatValue(item, strValue) {
            if (strValue.indexOf("::") > 0) {
                while (strValue.length > 0) {
                    var index = strValue.indexOf("::");
                    if (index > 0) {
                        var value = strValue.substring(0, index);
                        arrFieldName.push(item);
                        arrFieldValue.push(value);
                        strValue = strValue.substring(index + 2, strValue.length);
                    } else {
                        var value = strValue;
                        arrFieldName.push(item);
                        arrFieldValue.push(value);
                        strValue = "";
                    }
                }
            } else {
                arrFieldName.push(item);
                arrFieldValue.push(strValue);
            }
        }
    }

        //function AddNewItem() {
        //    var empObj = {
        //        formId: $("#listMarcFormID :selected").val(),
        //        dirCode: $("#levelDir :selected").val(),
        //        mediumId: $("#mediumId :selected").val(),
        //        recordTypeCode: $("#recordTypeCode :selected").val(),
        //        itemTypeId: $("#itemTypeId :selected").val(),
        //        accessLevel: $("#accessLevel :selected").val()
        //    };

        //    $.ajax({
        //        url: "/Catalogue/AddNewItem",
        //        type: "POST",
        //        data: JSON.stringify(empObj),
        //        contentType: "application/json;charset=utf-8",
        //        dataType: "json",
        //        success: function (code) {

        //            alert("Bạn Đã Tạo Thành Công Biên Mục : " + code);

        //        },
        //        error: function (errorThrown) {
        //            alert(errorThrown);
        //        }

        //    });
        //}
</script>





@*<div class="form-group row col-12">
        <label class="control-label col-md-3 align-self-center">ISBN[020$a] : </label>
        <input type="text" class="form-control col-md-2" id="inputEmail3">
        <label class="control-label col-md-2 align-self-center">ISSN[022$a] : </label>
        <input type="text" class="form-control col-md-2" id="inputEmail3">
    </div>*@


@*<script>

        function clicked(item) {

            $('<label class="control-label col-md-5 align-self-center font-weight-bold" > Truong Lap </label>  <input type="text" id="rep' + item.id + '" class="form-control row col-2"   style="margin-left: 0px"/> <a href="" id="remScnt">Remove</a> ').appendTo(item);
            $('#remScnt').click( function() {
                //remove
                debugger;
                $('#remScnt').empty();
            });
            return false;
        }
    </script>*@