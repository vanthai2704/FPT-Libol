@model Libol.Models.SYS_USER
@{
    ViewBag.Title = "Quản lý tài khoản";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@*START------------SCRIPT FOR DATATABLES*@
<link rel="stylesheet" type="text/css" href="~/Content/DataTables/DataTables-1.10.18/css/dataTables.bootstrap4.css">
<link rel="stylesheet" type="text/css" href="~/Content/DataTables/Select-1.3.0/css/select.bootstrap4.css">
<script type="text/javascript" charset="utf8" src="~/Content/DataTables/DataTables-1.10.18/js/jquery.dataTables.js"></script>
<script type="text/javascript" charset="utf8" src="~/Content/DataTables/DataTables-1.10.18/js/dataTables.bootstrap4.js"></script>
<script type="text/javascript" charset="utf8" src="~/Content/DataTables/Select-1.3.0/js/dataTables.select.js"></script>
<script>
    $(document).ready(function () {
        $('#table_account thead tr').clone(true).appendTo('#table_account thead');
        $('#table_account thead tr:eq(1) th').each(function (i) {
            if (i != 0) {
                var title = $(this).text();
                $(this).html('<input class="form-control" type="text" placeholder="Tìm ' + title + '" />');

                $('input', this).on('keyup change', function () {
                    if (table.column(i).search() !== this.value) {
                        table
                            .column(i)
                            .search(this.value)
                            .draw();
                    }
                });
            } else {
                $(this).html('');
            }
        });
        var table = $('#table_account').DataTable({
            "processing": true,
            "serverSide": true,
            ajax: {
                url: "/Management/Account",
                type: 'POST',
            },
            columns: [
                {
                    "data": null,
                    "defaultContent": ""
                },
                {
                    "data": "Username",
                    "render": function (data, type, row, meta) {
                        if (type === 'display') {
                            data = '<a href="/Management/Account?username='+data+'">' + data + '</a>';
                        }

                        return data;
                    }
                },
                { "data": "Name" },
            ],
            
            columnDefs: [{
                orderable: false,
                className: 'select-checkbox',
                targets: 0
            }],
            select: {
                style: 'os',
                selector: 'td:first-child'
            },
            order: [[1, 'asc']],
            orderCellsTop: true,
            
        });

        $('#table_account').on('click', '#select_all', function () {
            if ($('#select_all:checked').val() === 'on') {
                table.rows({ search: 'applied' }).select();
            }
            else {
                table.rows().deselect();
            }
        });
    });

</script>
@*END------------SCRIPT FOR DATATABLES*@
<form>
    <div class="form-row" style="margin-top : 1rem">
        <div class="col">
            <h4>Người dùng hiện thời</h4>
        </div>
        <div class="col">
            <h4>Thông tin chi tiết</h4>
        </div>
    </div>
    <div class="form-row">
        <div class="col">
            <table id="table_account" class="table table-striped table-bordered datatables">
                <thead>
                    <tr>
                        <th style="text-align: center;"><input type="checkbox" id="select_all" /></th>
                        <th>Tài khoản người dùng</th>
                        <th>Họ tên</th>
                    </tr>
                </thead>

            </table>
        </div>
        <div class="col">
            <div class="form-group row" style="padding-right : 3rem">
                <label class="control-label col-3 align-self-center text-right">Họ tên</label>
                <input type="text" class="form-control col" value="@Model.Name" id="txtName">
                <div class="invalid-feedback">
                    Vui lòng nhập Họ tên
                </div>
            </div>
            <div class="form-group row" style="padding-right : 3rem">
                <label class="control-label col-3 align-self-center text-right">Tên đăng nhập</label>
                <input type="text" class="form-control col" value="@Model.Username" id="txtUsername">
                <div class="invalid-feedback">
                    Vui lòng nhập Tên đăng nhập
                </div>
            </div>
            <div class="form-group row" style="padding-right : 3rem">
                <label class="control-label col-3 align-self-center text-right">Địa chỉ mail</label>
                @if (Model.SYS_USER_GOOGLE_ACCOUNT.Count() > 0)
                {
                    <input type="email" class="form-control col" value="@Model.SYS_USER_GOOGLE_ACCOUNT.First().Email" id="txtEmail">
                }
                else
                {
                    <input type="email" class="form-control col" id="txtEmail">
                }
                <div class="invalid-feedback">
                    Vui lòng nhập Email
                </div>
            </div>
            <div class="form-group row" style="padding-right : 3rem">
                <label class="control-label col-3 align-self-center text-right">Mật khẩu</label>
                <input type="password" class="form-control col" id="txtPassword">
                <div class="invalid-feedback">
                    Vui lòng nhập Mật khẩu
                </div>
            </div>
            <div class="form-group row" style="padding-right : 3rem">
                <label class="control-label col-3 align-self-center text-right">Gõ lại mật khẩu</label>
                <input type="password" class="form-control col" id="txtRepeatPassword">
                <div class="invalid-feedback">
                    Mật khẩu không khớp
                </div>
            </div>
            <div class="form-group row" style="padding-right : 3rem">
                <div class="col">
                    @if (Model.ID > 0)
                    {
                        <button type="button" class="btn btn-primary float-right" onclick="UpdateUser()">Cập nhật</button>
                    }
                    else
                    {
                        <button type="button" class="btn btn-primary float-right" onclick="CreateUser()">Cập nhật</button>
                    }
                </div>
                <div class="col">
                    <button type="button" class="btn btn-primary">Tạo mới</button>
                </div>


            </div>
        </div>
    </div>
    <input type="hidden" id="txtID" value="@Model.ID" />
    <div class="modal" tabindex="-1" role="dialog" id="modalNotifyUpdate">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thông tin tài khoản</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="notifyMessageUpdate" style="color: green;"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="reloadUpdate()">Đóng</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" tabindex="-1" role="dialog" id="modalNotify">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thông tin tài khoản</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="notifyMessage" style="color:red;"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
</form>



<script>
    function CreateUser() {

    }

    function UpdateUser() {
        var empObj = {
            ID: document.getElementById("txtID").value,
            Name: document.getElementById("txtName").value,
            Username: document.getElementById("txtUsername").value,
            Email: document.getElementById("txtEmail").value,
            Password: document.getElementById("txtPassword").value,
            RepeatPassword: document.getElementById("txtRepeatPassword").value
            
        }
        $.ajax({
            url: "/Management/UpdateUser",
            data: JSON.stringify(empObj),
            type: "POST",
            contentType: "application/json;charset=utf-8",
            success: function (result) {
                switch (result.CodeError) {
                    case 0:
                        $("#modalNotifyUpdate").modal();
                        document.getElementById("notifyMessageUpdate").innerHTML = result.Data;
                        break;
                    case 1:
                        showInvalid(result.Data);
                        break;
                    case 2:
                        $("#modalNotify").modal();
                        document.getElementById("notifyMessage").innerHTML = result.Data;
                        break;
                    default:
                        UploadPhotoPatronUpdate(result.Data);

                }
            },
            error: function (errormessage) {

            }
        });
    }

    function showInvalid(invalidFields) {
        var fields = invalidFields.split("-");
        for (i = 0; i < fields.length; i++) {
            if (fields[i] != "") {
                var element = document.getElementById(fields[i]);
                element.classList.add("is-invalid");
            }
        }
    }

    function hideInvalid(invalidFields) {
        var fields = invalidFields.split("-");
        for (i = 0; i < fields.length; i++) {
            if (fields[i] != "") {
                var element = document.getElementById(fields[i]);
                element.classList.remove("is-invalid");
            }
        }
    }

    function reloadUpdate() {
        window.location.href = "/Management/Account"
    }
</script>